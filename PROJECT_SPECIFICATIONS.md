# 音声自動カルテシステム - プロジェクト仕様書

## プロジェクト概要

### システム名
音声自動カルテ自動生成システム（Voice Medical Records System）

### 対象医院
芦屋Ⓡいいだ内科クリニック
- 専門分野: 内科・消化器内科
- 特化機能: 胃カメラ・大腸カメラ検査、生活習慣病管理

### システム目的
診察中の医師と患者の会話を自動的に音声認識し、構造化された医療記録（カルテ）として生成・保存するシステム

## システム構成

### アーキテクチャ
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Frontend  │───▶│  FastAPI Backend │───▶│   Dify Agent    │
│   (React/TS)    │    │    (Python)     │    │  (AI Processing)│
└─────────────────┘    └─────────────────┘    └─────────────────┘
         ▲                        │                        │
         │                        ▼                        │
         │              ┌─────────────────┐                │
         └──────────────│  Medical Record │◀───────────────┘
                        │   Generation    │
                        └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │ Google Sheets   │
                        │   Export        │
                        └─────────────────┘
```

### 技術スタック

#### フロントエンド
- **フレームワーク**: React 18 + TypeScript
- **ビルドツール**: Vite
- **スタイリング**: Tailwind CSS
- **UIコンポーネント**: shadcn/ui
- **音声処理**: Web Audio API
- **アイコン**: Lucide React

#### バックエンド
- **フレームワーク**: FastAPI (Python 3.12)
- **依存関係管理**: Poetry
- **HTTP クライアント**: httpx
- **ファイル処理**: Python標準ライブラリ
- **環境変数**: python-dotenv

#### AI処理
- **プラットフォーム**: Dify Agent
- **API**: Dify REST API v1
- **認証**: Bearer Token
- **ファイル処理**: Multipart Upload

## 機能仕様

### 1. 音声録音機能
- **音声入力**: Web Audio API使用
- **対応形式**: WAV (16-bit, モノラル)
- **録音制御**: 開始/停止ボタン
- **タイマー表示**: リアルタイム録音時間
- **エラーハンドリング**: マイクアクセス拒否対応

### 2. 患者情報管理
- **患者名**: 日本語フルネーム
- **患者ID**: 形式 P-YYYY-XXX
- **年齢**: 数値入力
- **性別**: 男性/女性選択
- **編集機能**: リアルタイム入力

### 3. Dify AI処理
- **音声アップロード**: Dify File Upload API
- **プロンプト生成**: 医療記録特化プロンプト
- **チャット処理**: Dify Chat Messages API
- **レスポンス解析**: 構造化データ抽出

### 4. 医療記録生成
- **診察日時**: 自動生成（YYYY-MM-DD HH:MM形式）
- **患者ID**: 入力データから取得
- **主訴**: 音声から抽出
- **現病歴**: 詳細な症状記録
- **身体所見**: 診察結果
- **診断**: 医学的判断
- **処方**: 薬剤情報
- **指導内容**: 患者への指示
- **次回予約**: フォローアップ
- **備考**: 追加情報

### 5. データ保存・出力
- **メモリ保存**: インメモリデータベース
- **記録一覧**: 生成済み記録の表示
- **Google Sheets出力**: スプレッドシート連携
- **JSON形式**: 構造化データ保存

## API仕様

### エンドポイント一覧

#### 1. GET /healthz
- **目的**: サーバーヘルスチェック
- **レスポンス**: `{"status": "ok"}`

#### 2. POST /api/process-audio
- **目的**: 音声ファイルと患者データの処理
- **入力**: 
  - `audio_file`: WAVファイル (multipart/form-data)
  - `patient_name`: 患者名 (string)
  - `patient_id`: 患者ID (string)
  - `patient_age`: 年齢 (string)
  - `patient_gender`: 性別 (string)
- **出力**:
```json
{
  "success": true,
  "medical_record": {
    "patient_id": "P-2025-001",
    "consultation_date": "2025-06-12 02:20",
    "chief_complaint": "腹痛、下痢症状",
    "present_illness": "3日前から腹痛と下痢が続いている...",
    "physical_examination": "腹部：軽度圧痛あり、腸音亢進",
    "diagnosis": "急性胃腸炎の疑い",
    "prescription": "整腸剤、止痢剤を処方",
    "guidance": "水分補給を心がけ、消化の良い食事を摂取してください",
    "next_appointment": "1週間後",
    "notes": "症状が改善しない場合は早めに受診"
  },
  "confidence_score": 0.85,
  "processing_time": 2.3
}
```

#### 3. POST /api/save-record
- **目的**: 医療記録の保存
- **入力**: MedicalRecord JSON
- **出力**: `{"success": true, "record_id": "uuid"}`

#### 4. GET /api/records
- **目的**: 保存済み記録の取得
- **出力**: `{"records": [...], "total": 10}`

#### 5. POST /api/export-to-sheets
- **目的**: Google Sheetsへのエクスポート
- **入力**: MedicalRecord JSON
- **出力**: `{"success": true, "sheet_url": "https://..."}`

## Dify統合仕様

### 1. ファイルアップロード
- **エンドポイント**: `POST /files/upload`
- **認証**: `Authorization: Bearer {API_KEY}`
- **形式**: multipart/form-data
- **レスポンス**: `{"id": "file_id", "name": "filename"}`

### 2. チャットメッセージ
- **エンドポイント**: `POST /chat-messages`
- **認証**: `Authorization: Bearer {API_KEY}`
- **入力**:
```json
{
  "inputs": {},
  "query": "医療記録生成プロンプト",
  "response_mode": "blocking",
  "conversation_id": "",
  "user": "medical-system",
  "files": [{"type": "file", "transfer_method": "remote_url", "url": "file_url"}]
}
```

### 3. プロンプト設計
```
あなたは経験豊富な内科・消化器内科の医師です。
以下の患者情報と音声記録を基に、構造化された医療記録を日本語で生成してください。

患者情報:
- 患者名: {patient_name}
- 患者ID: {patient_id}
- 年齢: {patient_age}歳
- 性別: {patient_gender}

音声記録から以下の項目を抽出し、JSON形式で出力してください:
- 主訴 (chief_complaint)
- 現病歴 (present_illness)
- 身体所見 (physical_examination)
- 診断 (diagnosis)
- 処方 (prescription)
- 指導内容 (guidance)
- 次回予約 (next_appointment)
- 備考 (notes)

特に消化器内科・内科の専門用語を適切に使用し、
飯田クリニックの診療方針に沿った記録を作成してください。
```

## セキュリティ仕様

### 1. 認証・認可
- **Dify API**: Bearer Token認証
- **Google Sheets**: OAuth 2.0認証
- **環境変数**: 機密情報の外部化

### 2. データ保護
- **音声ファイル**: 一時保存後自動削除
- **患者情報**: メモリ内処理
- **医療記録**: 暗号化推奨（本番環境）

### 3. エラーハンドリング
- **API障害**: 自動フォールバック
- **ネットワークエラー**: リトライ機能
- **ファイル形式エラー**: 適切なエラーメッセージ

## パフォーマンス仕様

### 1. 応答時間
- **音声アップロード**: < 5秒
- **Dify処理**: < 30秒
- **医療記録生成**: < 3秒
- **UI応答**: < 1秒

### 2. ファイルサイズ制限
- **音声ファイル**: 最大 10MB
- **録音時間**: 最大 10分
- **同時接続**: 10ユーザー

## 運用仕様

### 1. 環境要件
- **Node.js**: v18以上
- **Python**: 3.12
- **ブラウザ**: Chrome, Firefox, Safari最新版
- **ネットワーク**: インターネット接続必須

### 2. 監視・ログ
- **アクセスログ**: FastAPI標準ログ
- **エラーログ**: 例外情報記録
- **パフォーマンス**: 処理時間測定

### 3. バックアップ
- **ソースコード**: Git管理
- **設定ファイル**: 環境変数管理
- **医療記録**: 外部ストレージ推奨

## 拡張仕様

### 1. 将来的な機能追加
- **音声品質向上**: ノイズキャンセリング
- **多言語対応**: 英語・中国語対応
- **画像添付**: 検査画像の統合
- **電子カルテ連携**: 既存システム統合

### 2. スケーラビリティ
- **マイクロサービス化**: 機能分離
- **クラウド対応**: AWS/Azure展開
- **負荷分散**: 複数インスタンス対応

## 品質保証

### 1. テスト仕様
- **単体テスト**: 各API関数
- **統合テスト**: エンドツーエンド
- **負荷テスト**: 同時接続テスト
- **セキュリティテスト**: 脆弱性検査

### 2. 品質基準
- **可用性**: 99.9%
- **精度**: 医療記録生成 90%以上
- **セキュリティ**: OWASP準拠
- **ユーザビリティ**: 医療スタッフ向け最適化

---

**文書作成日**: 2025年6月12日  
**バージョン**: 1.0  
**作成者**: Devin AI  
**対象**: 飯田クリニック音声自動カルテシステム
